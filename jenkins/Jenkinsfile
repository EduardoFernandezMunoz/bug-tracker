pipeline {
    agent any

    environment {
        GO111MODULE = 'on'
        NODE_ENV = 'test'
        REPORTS_DIR = 'reports'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Tool Install') {
            steps {
                echo "Usando Go y Node instalados en el sistema"
            }
        }

        stage('Prepare Reports Folder') {
            steps {
                bat "if not exist ${REPORTS_DIR} mkdir ${REPORTS_DIR}"
            }
        }

        stage('Unit Tests') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('bugtracker-backend') {
                            bat 'go install github.com/jstemmer/go-junit-report@latest'
                            // Ejecutar tests y generar JUnit XML
                            bat 'go test -v ./... | go-junit-report > ../reports/backend-tests.xml'
                            // Generar cobertura
                            bat 'go test -coverprofile=coverage.out -covermode=atomic ./...'
                            bat 'go tool cover -html=coverage.out -o ../reports/coverage.html'
                        }
                    }
                    post {
                        always {
                            junit 'reports/backend-tests.xml'
                        }
                    }
                }

                stage('Frontend Tests') {
                    steps {
                        dir('bugtracker-frontend') {
                            // Instalar dependencias
                            bat 'npm ci'
                            // Ejecutar tests con jest-junit
                            bat 'npx jest --coverage --coverageReporters=html,text --reporters=default --reporters=jest-junit'
                        }
                    }
                    post {
                        always {
                            junit 'reports/frontend-tests.xml'
                        }
                    }
                }
            }
        }

        stage('Launch Backend') {
            steps {
                script {
                    // Solo levantar backend para tests de API/E2E
                    if(fileExists('docker-compose.yml')) {
                        bat 'docker-compose up -d backend'
                        bat 'timeout /t 5' // espera 5 segundos a que levante
                    } else {
                        echo "No docker-compose.yml found, skipping backend launch"
                    }
                }
            }
        }

        stage('API Tests') {
            steps {
                echo 'Aquí irían tus tests de API (si existen)'
            }
        }

        stage('E2E Tests') {
            steps {
                echo 'Aquí irían tus tests E2E (si existen)'
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace and Docker containers...'
            cleanWs()
            script {
                if(fileExists('docker-compose.yml')) {
                    bat 'docker-compose down || echo "No docker-compose file found, skipping cleanup"'
                }
            }
        }
    }
}
